<!doctype html><html dir=ltr lang=en data-theme><head>
<title> Dr Sarah Gibson | HelmUpgradeBot </title>
<meta charset=utf-8><meta name=generator content="Hugo 0.91.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name=description content="A Bot to manage BinderHubs">
<link rel=stylesheet href=/css/main.min.f79a5de55310cc058fc81804d033ddb955937d778bd533d9ea05b1c798501013.css integrity="sha256-95pd5VMQzAWPyBgE0DPduVWTfXeL1TPZ6gWxx5hQEBM=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=/css/markupHighlight.min.f798cbda9aaa38f89eb38be6414bd082cfd71a6780375cbf67b6d2fb2b96491e.css integrity="sha256-95jL2pqqOPies4vmQUvQgs/XGmeAN1y/Z7bS+yuWSR4=" crossorigin=anonymous type=text/css>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous>
<link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon>
<link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png>
<link rel=canonical href=/project/helmupgradebot/>
<script type=text/javascript src=/js/anatole-header.min.0c05c0a90d28c968a1cad4fb31abd0b8e1264e788ccefed022ae1d3b6f627514.js integrity="sha256-DAXAqQ0oyWihytT7MavQuOEmTniMzv7QIq4dO29idRQ=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/anatole-theme-switcher.min.7fd87181cdd7e8413aa64b6867bb32f3a8dc242e684fc7d5bbb9f600dbc2b6eb.js integrity="sha256-f9hxgc3X6EE6pktoZ7sy86jcJC5oT8fVu7n2ANvCtus=" crossorigin=anonymous></script>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://sgibson91.github.io/images/profile_pic.jpg">
<meta name=twitter:title content="HelmUpgradeBot">
<meta name=twitter:description content="A Bot to manage BinderHubs">
</head>
<body><div class="sidebar animated fadeInDown">
<div class=logo-title>
<div class=title>
<img src=/images/profile_pic.jpg alt="profile picture">
<h3 title><a href=/>Dr Sarah Gibson</a></h3>
<div class=description>
<p>Open Software - Open Infrastructure - Open Science</p>
</div>
</div>
</div>
<ul class=social-links>
<li>
<a href=https://github.com/sgibson91 rel=me aria-label=GitHub>
<i class="fab fa-github fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=https://twitter.com/drsarahlgibson rel=me aria-label=Twitter>
<i class="fab fa-twitter fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=mailto:drsarahlgibson@gmail.com rel=me aria-label=e-mail>
<i class="fas fa-envelope fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=https://orcid.org/0000-0003-0356-2765 rel=me aria-label=ORCID>
<i class="fab fa-orcid fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=https://www.linkedin.com/in/drsarahlgibson/ rel=me aria-label=LinkedIn>
<i class="fab fa-linkedin fa-2x" aria-hidden=true></i>
</a>
</li>
<li>
<a href=https://calendly.com/sgibson-2i2c rel=me aria-label=Calendar>
<i class="fas fa-calendar fa-2x" aria-hidden=true></i>
</a>
</li>
</ul>
<div class=footer>
<div class=by_farbox>&copy; Dr Sarah Gibson 2021 </div>
</div>
</div>
<div class=main>
<div class="page-top animated fadeInDown">
<a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span>
</a>
<ul class=nav id=navMenu>
<li><a href=/ title>Home</a></li>
<li><a href=/blog/ title>Blog</a></li>
<li><a href=/speaking/ title>Speaking</a></li>
<li><a href=/media/ title>Media</a></li>
<li><a href=https://sgibson91.github.io/cv/ target=_blank rel="noopener noreferrer" title>CV</a></li>
<li class=theme-switch-item>
<a class=theme-switch title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a>
</li>
</ul>
</div>
<div class=autopagerize_page_element>
<div class=content>
<div class="post animated fadeInDown">
<div class=post-content>
<div class=post-title>
<h3>HelmUpgradeBot</h3>
</div>
<p>While managing <a href=https://binderhub.readthedocs.io/en/latest/>BinderHubs</a>, I found that there were a lot of things I had to deal with manually and, inevitably, I failed to keep on top of them.
Most notably, the two biggest problems I faced were <em>i)</em> keeping my BinderHub up-to-date with the latest software released by the Binder team, and <em>ii)</em> keeping the size of the image registry manageable and within budget.</p>
<p>Hence I developed <a href=https://github.com/HelmUpgradeBot>HelmUpgradeBot</a>!</p>
<h2 id=keeping-software-up-to-date>Keeping software up-to-date</h2>
<p>The first problem I wanted to solve was the manual updates I had to perform to keep my BinderHub up-to-date with the software the Binder team releases, packaged as a <a href=https://jupyterhub.github.io/helm-chart/>Helm Chart</a>.
Thankfully, this was a problem that had already been solved for <a href=https://mybinder.org>mybinder.org</a>!</p>
<p><a href=https://github.com/henchc>Chris Hench</a> had already written <a href=https://github.com/henchbot/mybinder.org-upgrades>henchbot</a> to deploy updates to mybinder.org, <em>and</em> had written <a href=https://blog.jupyter.org/automating-mybinder-org-dependency-upgrades-in-10-steps-bb5e38542059>a blog post</a> describing the process of creating it.
All I needed to do was tweak the code for my specific set-up - specifically, interacting with Azure resources.</p>
<p><a href=https://github.com/HelmUpgradeBot/hub23-deploy-upgrades/>Check out the code for Helm Chart upgrades.</a></p>
<h2 id=interacting-with-azure>Interacting with Azure</h2>
<p>The trick with the Helm Chart upgrades was running the bot from a place that could interact with the Azure resources I had set up to support my BinderHub - namely, the <a href=https://azure.microsoft.com/en-gb/services/key-vault/>Key Vault</a>, which was where I chose to store my Personal Access Token rather than parse it as an environment variable (as in the henchbot example).</p>
<p>I needed to run this from a server that could scrape the Helm Chart page at regular intervals.
The solution that made most sense was to create a Virtual Machine in Azure and assign it a <a href=https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview#how-a-system-assigned-managed-identity-works-with-an-azure-vm>Managed System Identity</a> with enough permissions to read from the Key Vault.
The bot could then login to Azure using the identity of the VM it was running on, and retrieve the PAT from the Key Vault.
Once I had perfected this section of the code, it was just a matter of following Chris&rsquo;s blog post to code the interactions with GitHub (for example, create a fork and pull request) and then deploy the code as a <a href=https://crontab.guru/>cron job</a> on the Azure VM to perform a daily check for updates.</p>
<h2 id=cleaning-up-artefacts>Cleaning up artefacts</h2>
<p>One thing that BinderHubs produce is a <em>lot</em> of Docker images.
If you&rsquo;re using a private Docker registry, such as <a href=https://azure.microsoft.com/en-gb/services/container-registry/>Azure Container Registry</a>, then the size (and hence the cost!) can soar very quickly.
So I wanted to apply what I&rsquo;d learned deploying the Helm Chart upgrades to automatically clean out my Docker registry at regular intervals.</p>
<p><a href=https://github.com/HelmUpgradeBot/DockerCleanUp/>Check out the code for cleaning a Docker registry.</a></p>
<p>I already had a basis for how to deploy such a code:</p>
<p>✔️ Programmatically interacting with Azure login</p>
<p>✔️ Virtual Machines with access to cloud resources</p>
<p>✔️ Writing cron expressions</p>
<p>Next, I began to investigate how to <a href="https://docs.microsoft.com/en-us/cli/azure/acr?view=azure-cli-latest">programmatically interact with the Docker registry</a> itself.</p>
<p>I wanted to sort the images both by age and size since large images will obviously fill the repository up more quickly, and older images are less likely to be actively used or have been rebuilt under a different tag.
I achieved this by scraping the manifests of the repositories and images within the registry and creating a dataframe to sort the images.</p>
<p>I also created an &ldquo;aggressive&rdquo; mode which would activate when the total size of the registry exceeds a pre-set, tunable limit.
This would then delete the largest images in order to bring the size under the prescribed limit.</p>
<p>Currently, this bot runs monthly to check the size of the registry isn&rsquo;t growing too large.</p>
</div>
<div class=post-footer>
<div class=info>
<span class=separator><a class=tag href=/tags/reproducibility/>reproducibility</a><a class=tag href=/tags/binderhub/>binderhub</a><a class=tag href=/tags/automation/>automation</a></span>
</div>
</div>
</div>
</div>
</div>
</div>
<script type=text/javascript src=/js/medium-zoom.min.83cb1dd5fea8d42d87d1e601a07faa73089ad0ef9ccfe5daf6041289ebcc4e46.js integrity="sha256-g8sd1f6o1C2H0eYBoH+qcwia0O+cz+Xa9gQSievMTkY=" crossorigin=anonymous></script></body>
</html>